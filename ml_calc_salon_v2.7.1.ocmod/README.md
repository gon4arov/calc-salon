# Калькулятор окупаемости салона v2.7.1

Модуль для OpenCart 2.3.0.2 для расчета окупаемости оборудования салона с поддержкой множественного выбора товаров.

## Возможности

- ✅ Добавление нескольких товаров в расчет
- ✅ Индивидуальные параметры для каждого товара (клиенты/день, стоимость процедуры, процент мастера)
- ✅ Общие параметры салона (рабочие дни, аренда, коммунальные услуги)
- ✅ Пропорциональное распределение общих расходов по выручке
- ✅ Сохранение и загрузка расчетов через ссылки
- ✅ Хранение корзины товаров в LocalStorage
- ✅ Расчет общей окупаемости салона и индивидуальной по каждому товару
- ✅ Адаптивный дизайн для мобильных устройств
- ✅ Поддержка 3 языков (ru-ru, uk-ua, en-gb)

## Установка

1. Скопируйте содержимое папки `upload/` в корень вашего OpenCart
2. Перейдите в админ-панель: **Расширения → Модули**
3. Найдите "Калькулятор окупаемости салона" и нажмите "Установить"
4. Нажмите "Редактировать" для настройки модуля

## Настройка

В настройках модуля вы можете указать значения по умолчанию:
- Количество клиентов в день
- Стоимость процедуры
- Количество рабочих дней в месяц
- Аренда помещения
- Коммунальные услуги
- Процент мастера

## Использование

### Для товаров

Установите JAN = '1' для товаров, которые должны быть доступны в калькуляторе салона.

### Для покупателей

1. Перейдите на страницу калькулятора салона
2. Выберите товары из списка
3. Настройте индивидуальные параметры для каждого товара
4. Настройте общие параметры салона
5. Нажмите "Рассчитать"
6. При необходимости сохраните расчет и поделитесь ссылкой

## Логика расчетов

### Распределение расходов

Общие расходы (аренда + коммунальные услуги) распределяются между товарами пропорционально их вкладу в общую выручку:

```
Выручка товара = (Клиенты/день × Стоимость процедуры × Рабочие дни) - (Выручка × Процент мастера / 100)
Общая выручка = Σ Выручка всех товаров
Доля товара = Выручка товара / Общая выручка
Расходы товара = (Аренда + Комм. услуги) × Доля товара
Чистая прибыль товара = Выручка товара - Расходы товара
Окупаемость товара = Цена товара / Чистая прибыль товара
```

### Общая окупаемость

```
Общая стоимость = Σ Цены всех товаров
Общая чистая прибыль = Σ Чистых прибылей всех товаров
Окупаемость салона = Общая стоимость / Общая чистая прибыль
```

## База данных

Модуль создает таблицу `oc_ml_calc_salon_calculations` для хранения сохраненных расчетов:

```sql
CREATE TABLE IF NOT EXISTS `oc_ml_calc_salon_calculations` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `share_token` varchar(32) NOT NULL,
  `calculation_data` TEXT NOT NULL,
  `created_at` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `share_token` (`share_token`)
);
```

## API

### GET /index.php?route=extension/module/ml_calc_salon
Главная страница калькулятора

### GET /index.php?route=extension/module/ml_calc_salon/getProducts
Список доступных товаров (JAN='1')

### POST /index.php?route=extension/module/ml_calc_salon/calculateMultiple
Расчет окупаемости для корзины товаров

**Параметры:**
- `products[]` - массив товаров с параметрами
- `working_days` - рабочие дни
- `rent` - аренда
- `utilities` - коммунальные услуги

### POST /index.php?route=extension/module/ml_calc_salon/saveCalculation
Сохранение расчета

**Параметры:**
- `calculation_data` - JSON с данными расчета

**Ответ:**
```json
{
  "success": true,
  "share_token": "abc123...",
  "url": "/index.php?route=extension/module/ml_calc_salon&share=abc123..."
}
```

### GET /index.php?route=extension/module/ml_calc_salon&share=TOKEN
Загрузка сохраненного расчета

## Безопасность

Модуль включает защиту от:
- CSRF атак (проверка HTTP Referer)
- SQL injection (использование prepared statements и escape)
- XSS (санитизация входных данных)
- Валидация всех входных параметров

## Требования

- OpenCart 2.3.0.2+
- PHP 5.4+
- MySQL 5.5+
- jQuery

## Техническая поддержка

По вопросам работы модуля обращайтесь:
- Email: support@masterlaser.ua
- Сайт: https://www.masterlaser.ua/

## Версия

**2.7.1** - Исправлены проблемы:
- Фильтрация товаров по JAN='1' через прямой SQL запрос
- Приведение типов product_id для корректной работы корзины
- Добавлена расширенная отладка через console.log

**2.7.0** - Добавлен калькулятор окупаемости салона с поддержкой множественного выбора товаров

## Автор

MasterLaser © 2024

## Лицензия

Proprietary - Все права защищены
